<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Session Debug - MindSpace</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .debug-section {
      background: white;
      padding: 20px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #2D6A4F;
    }
    button {
      background: #2D6A4F;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #1B4332;
    }
    .error { color: #DC3545; }
    .success { color: #52B788; }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîç MindSpace Session Debugger</h1>
  
  <div class="debug-section">
    <h2>Database Status</h2>
    <button onclick="checkDatabase()">Check Database</button>
    <div id="dbStatus"></div>
  </div>

  <div class="debug-section">
    <h2>Session Status</h2>
    <button onclick="checkSession()">Check Current Session</button>
    <button onclick="checkAllSessions()">Check All Sessions</button>
    <div id="sessionStatus"></div>
  </div>

  <div class="debug-section">
    <h2>Test Login</h2>
    <button onclick="testLogin()">Test Login (demo@mindspace.com)</button>
    <div id="loginStatus"></div>
  </div>

  <div class="debug-section">
    <h2>LocalStorage</h2>
    <button onclick="checkLocalStorage()">Check LocalStorage</button>
    <div id="storageStatus"></div>
  </div>

  <div class="debug-section">
    <h2>Actions</h2>
    <button onclick="clearAllSessions()">Clear All Sessions</button>
    <button onclick="clearLocalStorage()">Clear LocalStorage</button>
    <button onclick="reinitDB()">Reinitialize Database</button>
  </div>

  <!-- Include your scripts -->
  <script src="js/db.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/auth.js"></script>

  <script>
    // === FIX FOR login.html ===
    // Replace the login form submission handler with this:
    
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('rememberMe').checked;

      // Clear previous errors
      UIUtils.clearError('emailError');
      UIUtils.clearError('passwordError');
      UIUtils.clearError('formError');

      // Validate inputs
      if (!ValidationUtils.isValidEmail(email)) {
        UIUtils.showError('emailError', 'Please enter a valid email address');
        return;
      }

      if (!ValidationUtils.isNotEmpty(password)) {
        UIUtils.showError('passwordError', 'Password is required');
        return;
      }

      // Attempt login
      try {
        const result = await Auth.login(email, password, rememberMe);
        
        if (result.success) {
          // IMPORTANT: Wait a bit to ensure IndexedDB transaction completes
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Verify session was created before redirecting
          const session = await AuthUtils.getCurrentSession();
          if (session) {
            UIUtils.showNotification('Login successful! Redirecting...', 'success');
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 500);
          } else {
            // Session creation failed
            UIUtils.showError('formError', 'Login succeeded but session creation failed. Please try again.');
          }
        } else {
          UIUtils.showError('formError', result.message || 'Invalid email or password');
        }
      } catch (error) {
        console.error('Login error:', error);
        UIUtils.showError('formError', 'An error occurred. Please try again.');
      }
    });
  </script>

  <script>
    // Wait for DB to initialize
    let dbReady = false;
    
    window.addEventListener('DOMContentLoaded', async () => {
      await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for DB init
      dbReady = true;
      console.log('Debug page ready');
    });

    async function checkDatabase() {
      const output = document.getElementById('dbStatus');
      if (!mindspaceDB || !mindspaceDB.db) {
        output.innerHTML = '<p class="error">‚ùå Database not initialized!</p>';
        return;
      }
      
      try {
        const users = await mindspaceDB.getAll('users');
        const therapists = await mindspaceDB.getAll('therapists');
        const sessions = await mindspaceDB.getAll('sessions');
        
        output.innerHTML = `
          <p class="success">‚úÖ Database initialized</p>
          <pre>Users: ${users.length}
Therapists: ${therapists.length}
Sessions: ${sessions.length}</pre>
        `;
      } catch (error) {
        output.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
      }
    }

    async function checkSession() {
      const output = document.getElementById('sessionStatus');
      
      try {
        const session = await AuthUtils.getCurrentSession();
        if (session) {
          output.innerHTML = `
            <p class="success">‚úÖ Session found</p>
            <pre>${JSON.stringify(session, null, 2)}</pre>
          `;
        } else {
          output.innerHTML = '<p class="error">‚ùå No session found</p>';
        }
      } catch (error) {
        output.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
      }
    }

    async function checkAllSessions() {
      const output = document.getElementById('sessionStatus');
      
      try {
        const sessions = await mindspaceDB.getAll('sessions');
        output.innerHTML = `
          <p class="success">Found ${sessions.length} session(s)</p>
          <pre>${JSON.stringify(sessions, null, 2)}</pre>
        `;
      } catch (error) {
        output.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
      }
    }

    async function testLogin() {
      const output = document.getElementById('loginStatus');
      output.innerHTML = '<p>Testing login...</p>';
      
      try {
        // First check if demo user exists
        const users = await mindspaceDB.getByIndex('users', 'email', 'demo@mindspace.com');
        
        if (users.length === 0) {
          output.innerHTML = '<p class="error">‚ùå Demo user not found. Database might not be seeded.</p>';
          return;
        }
        
        output.innerHTML += `<p class="success">‚úÖ Demo user found</p>`;
        
        // Try login
        const result = await Auth.login('demo@mindspace.com', 'demo123', false);
        
        if (result.success) {
          output.innerHTML += `
            <p class="success">‚úÖ Login successful!</p>
            <pre>${JSON.stringify(result, null, 2)}</pre>
          `;
          
          // Check if session was created
          setTimeout(async () => {
            const session = await AuthUtils.getCurrentSession();
            if (session) {
              output.innerHTML += '<p class="success">‚úÖ Session created successfully</p>';
            } else {
              output.innerHTML += '<p class="error">‚ùå Login succeeded but no session found!</p>';
            }
          }, 500);
        } else {
          output.innerHTML += `<p class="error">‚ùå Login failed: ${result.message}</p>`;
        }
      } catch (error) {
        output.innerHTML += `<p class="error">‚ùå Error: ${error.message}</p>`;
        console.error('Login test error:', error);
      }
    }

    async function checkLocalStorage() {
      const output = document.getElementById('storageStatus');
      const token = localStorage.getItem('mindspace_session');
      
      if (token) {
        output.innerHTML = `
          <p class="success">‚úÖ Session token in localStorage</p>
          <pre>${token}</pre>
        `;
      } else {
        output.innerHTML = '<p class="error">‚ùå No session token in localStorage</p>';
      }
    }

    async function clearAllSessions() {
      try {
        const sessions = await mindspaceDB.getAll('sessions');
        for (const session of sessions) {
          await mindspaceDB.delete('sessions', session.userId);
        }
        alert('All sessions cleared');
        checkAllSessions();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function clearLocalStorage() {
      localStorage.removeItem('mindspace_session');
      alert('LocalStorage cleared');
      checkLocalStorage();
    }

    async function reinitDB() {
      try {
        await mindspaceDB.init();
        await mindspaceDB.seedDemoData();
        alert('Database reinitialized');
        checkDatabase();
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }
  </script>
</body>
</html>
